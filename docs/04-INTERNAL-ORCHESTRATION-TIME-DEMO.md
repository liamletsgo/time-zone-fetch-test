# â³ Internal Orchestration v1.0 â€“ Time Demo (Agentic Playground)

---

## 1. Why This Exists

This repo is a **sandbox for internal orchestration and agentic patterns**, not a serious "time" app.

We used a **trivial domain (timezones)** on purpose so we could safely:

* Practice the pattern: **tools â†’ agents â†’ orchestrators â†’ API â†’ UI â†’ CLI**.
* Teach an AI dev agent (Cursor) how to:
    * Read specs and dev contracts.
    * Create multiple files in the right places.
    * Wire imports correctly.
    * Write and run tests (`npm test`).
    * Log changes in `logs/AGENT-CHANGELOG.md`.
* Prove out the idea of **HAi (Human + AI)**:
    * **Human**: asks questions, sets direction.
    * **AI**: writes the code, runs tests/CLI, and answers based on real runtime behavior.

The *time demo* is our **Internal Orchestration v1.0** pattern. Later, the same pattern will be reused for more serious agents (SEO, content, etc.).

---

## 2. Architecture at a Glance

### 2.1 Layers

We deliberately split logic into layers:

* **Tools (`src/tools`)**
    * Pure, stateless utilities.
    * Example: `getCurrentTimeInZone(timezone: TimezoneId)`.

* **Agents (`src/agents`)**
    * Small, single-responsibility wrappers around tools.
    * Example: `HumanTimeAgent`:
        * Takes a timezone.
        * Calls `getCurrentTimeInZone`.
        * Returns a structured result + human-readable sentence.

* **Orchestrators (`src/orchestrators`)**
    * Coordinate one or more agents to achieve a higher-level goal.
    * Example: `runAllHumanTimesWorkflow`:
        * Calls `HumanTimeAgent` for each supported timezone.
        * Returns a stable array of results.

* **API Routes (`src/app/api`)**
    * Thin HTTP wrappers that call orchestrators.
    * Example: `/api/time-human`, `/api/time-human/all`.

* **UI Pages (`src/app/.../page.tsx`)**
    * Simple Next.js App Router pages that call the API and show results.
    * Example: `/time-human`.

* **CLI Scripts (`src/scripts`)**
    * Node entry points for dev tools / diagnostics.
    * Example: `humanTimeAllCli.ts` â†’ `npm run time:human-all`.

### 2.2 AI Dev Agent Integration (Cursor)

We also wired this into **Cursor's `.cursorrules`** so that:

* When the user asks:

    > "What time is it in Tokyo, London, and New York?"

* Cursor:
    * Runs `npm run time:human-all` in the integrated terminal.
    * Reads the CLI output generated by our orchestrator/agents.
    * Answers in natural language, grounded in the actual runtime behavior.

This is our first example of **an AI Agent using our internal tools**, rather than guessing.

---

## 3. File & Folder Map (Core Demo)

Key files involved in Internal Orchestration v1.0:

### 3.1 Docs & Rules

* `docs/01-DEV-CONTRACT.md`
    * Dev contract: architecture, layering rules, testing expectations.
* `docs/02-AGENT-ROLES.md`
    * Defines: Architect Agent, Coder Agent, Reviewer Agent.
* `docs/03-AI-BEST-PRACTICES.md`
    * Guidelines for how AI tools should behave in this repo.
* `docs/04-INTERNAL-ORCHESTRATION-TIME-DEMO.md` (this file)
    * Narrative of why and how we built this time demo.
* `logs/AGENT-CHANGELOG.md`
    * Reverse-chronological log of non-trivial changes (AI + human).
* `.cursorrules`
    * Repo-level "system prompt" for Cursor in this project.

### 3.2 Time Tools & Agents

* `src/tools/timeTools.ts`
    * Defines:
        * `TimezoneId` (union of supported timezones).
        * `ZonedTime` (shape for timezone-specific timestamps).
        * `getCurrentTimeInZone(timezone: TimezoneId)`.
        * `convertIsoToZone(iso: string, timezone: TimezoneId)`.
* `src/config/timeLabels.ts`
    * `TIMEZONE_LABELS: Record<TimezoneId, string>` â€“ e.g. `"Asia/Tokyo" â†’ "Tokyo"`.
    * `HumanTimeResult` type:
        * `timezone`, `iso`, `label`, `city`, `sentence`.
* `src/agents/humanTimeAgent.ts`
    * `HumanTimeAgent` with a `run(timezone: TimezoneId): HumanTimeResult`.
    * Steps:
        * Call `getCurrentTimeInZone(timezone)`.
        * Map timezone â†’ city name (via `TIMEZONE_LABELS`).
        * Use `Intl.DateTimeFormat("en-US", { timeZone: ... })` to format.
        * Build: `"The time in Tokyo is November 14, 2025, 9:15 AM."`.
        * Return `HumanTimeResult`.

### 3.3 Orchestrators

* `src/orchestrators/timeWorkflow.ts`
    * `runTimeWorkflow(config)` (original demo â€” source + target timezones).
    * `runAllHumanTimesWorkflow()`:
        * Uses `HumanTimeAgent` to fetch all supported timezones in a stable order.
* `src/orchestrators/timeWorkflow.test.ts`
    * Tests for:
        * `runTimeWorkflow` happy path.
        * `runAllHumanTimesWorkflow`:
            * Returns 4 entries.
            * Order: `Asia/Tokyo`, `America/New_York`, `Europe/London`, `UTC`.
            * Each entry has non-empty `city` and `sentence`.

### 3.4 API Routes

* `src/app/api/time-workflow/route.ts`
    * Original JSON-only time workflow (source â†’ targets).
* `src/app/api/time-human/route.ts`
    * `GET /api/time-human?tz=...`
    * Uses `runHumanTimeWorkflow(timezone)`.
    * Handles:
        * Missing `tz` â†’ default to `"America/New_York"`.
        * Invalid `tz` â†’ `400 { ok: false, error: "Unsupported timezone" }`.
        * Valid `tz` â†’ `200 { ok: true, data: HumanTimeResult }`.
* `src/app/api/time-human/all/route.ts`
    * `GET /api/time-human/all`
    * Uses `runAllHumanTimesWorkflow()`.
    * Returns:
        * `200 { ok: true, data: HumanTimeResult[] }` for all timezones.

### 3.5 UI Pages

* `src/app/time-demo/page.tsx`
    * Original demo page for raw workflow JSON.
* `src/app/time-human/page.tsx`
    * Client component that:
        * Lets user pick a timezone.
        * Button: **Show Time** â†’ calls `/api/time-human?tz=...`.
        * Button: **Show All Timezones** â†’ calls `/api/time-human/all`.
        * Displays sentences from `HumanTimeAgent` in a friendly way.

### 3.6 CLI Scripts

* `src/scripts/demoTimeWorkflow.ts`
    * Calls `runTimeWorkflow` and prints source/targets.
* `src/scripts/humanTimeAllCli.ts`
    * Calls `runAllHumanTimesWorkflow`.
    * Prints:
        * Human sentences for each timezone.
        * JSON payload (for debugging).

`package.json` scripts (relevant):

```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "next lint",
  "test": "vitest",
  "time:demo": "tsx src/scripts/demoTimeWorkflow.ts",
  "time:human-all": "tsx src/scripts/humanTimeAllCli.ts"
}
```

---

## 4. How to Re-Run This Demo (Future You / Colleague)

### 4.1 Prerequisites

* **Node.js** (matching whatever version was used originally, e.g. â‰¥ 18).
* **npm**.
* Dependencies already installed via:
  ```bash
  npm install
  ```
  `create-next-app` + our additions should have already set up everything needed, including `tsx`.

### 4.2 Run tests

```bash
npm test
```

Ensures tools, agents, and orchestrators behave as expected.

### 4.3 Start dev server (port 3001 or whatever you prefer)

```bash
npm run dev -- -p 3001
```

Open in the browser:
* **Root**: `http://localhost:3001/`
* **Raw JSON time workflow**: `http://localhost:3001/api/time-workflow`
* **Human time (default TZ)**: `http://localhost:3001/api/time-human`
* **Human time (specific TZ)**: `http://localhost:3001/api/time-human?tz=Asia/Tokyo`
* **All human times**: `http://localhost:3001/api/time-human/all`
* **UI page**: `http://localhost:3001/time-human`

### 4.4 Run CLI demo

```bash
npm run time:human-all
```

You should see human-readable time sentences for all supported timezones plus the JSON payload.

---

## 5. Cursor / AI Agent Behavior (How We Wired It)

The `.cursorrules` file tells Cursor how to behave in this repo. For this demo specifically, the relevant section is:

```
- When the user asks about the current time in any of the supported timezones
  (Asia/Tokyo, America/New_York, Europe/London, UTC) while working in this repo:
  - Prefer to use the existing internal tools instead of guessing.
  - Run `npm run time:human-all` in the integrated terminal.
  - Read the CLI output.
  - Answer the user in natural language, e.g. 
    "In Tokyo it is ..., in London it is ..., in New York it is ...",
    using the sentences printed by the script.
  - If the dev server is required instead (e.g. using the HTTP API), first run
    `npm run dev -- -p 3001` and then `curl http://localhost:3001/api/time-human/all`
    and base your answer on that JSON.
```

**Result:**

* **You type in Cursor:** "What time is it right now in Tokyo, London, and New York?"
* **Cursor:**
  * Runs `npm run time:human-all`.
  * Reads the `HumanTimeAgent` sentences from stdout.
  * Replies with a human summary based on those sentences.

This is a small but important pattern: **AI Agent doesn't guess â†’ it uses our code as a tool.**

---

## 6. Lessons Learned / Pitfalls We Hit

### 6.1 Route & File Naming

**App Router file naming matters:**
* `src/app/time-human/page.tsx` â†’ `/time-human`
* If the folder didn't exist, we got a 404.
* If the file existed but didn't export a valid React component, we got:
  ```
  Error: The default export is not a React Component in "/time-human/page".
  ```

### 6.2 HTML vs JSON (Unexpected token <)

When the UI called `/api/time-human/all` before we created the route, Next.js returned an HTML 404 page.

The frontend tried to `res.json()` that HTML and we saw:
```
Unexpected token '<', "<!DOCTYPE "... is not valid JSON
```

**Fix:** implement the route under `src/app/api/time-human/all/route.ts` so that the response is valid JSON.

### 6.3 Ports & Multiple Next.js Apps

We already had something on port 3000, so we ran this app on 3001:
```bash
npm run dev -- -p 3001
```

Remember to always hit `http://localhost:3001/...` for this project.

### 6.4 Small Steps, Strong Pattern

The domain (timezones) is trivial, but:
* It let us focus on **architecture, not business logic**.
* We validated the full loop: **Spec â†’ code â†’ tests â†’ API â†’ UI â†’ CLI â†’ Cursor integration**.

---

## 7. How To Recreate This Pattern for a Different Domain

If Future You (or a colleague) wants to create a new agentic demo (e.g., SEO health snapshot), the high-level steps would be:

1. **Define the goal & minimal demo domain**
   * Example: "Given a URL, call PSI and summarize mobile score + key issues."

2. **Create a spec in `specs/`**
   * Inputs / outputs.
   * Tools (e.g., PSI client, HTML parser).
   * Agents (e.g., `SeoMetricsAgent`, `PlainLanguageExplainerAgent`).
   * Orchestrator(s).
   * API routes.
   * Tests and acceptance criteria.

3. **Update docs if needed**
   * **Dev Contract** if introducing new patterns.
   * **Best Practices** if adding new rules (e.g., API key handling).

4. **Use Cursor as Coder Agent**
   * Prompt:
     ```
     Read docs/01-DEV-CONTRACT.md and specs/seo-demo.md. Implement all tools,
     agents, orchestrators, API routes, tests. Run npm test. Update logs/AGENT-CHANGELOG.md.
     ```

5. **Add a CLI tool & rule (optional but recommended)**
   * `src/scripts/seoHealthCli.ts`.
   * `npm run seo:health`.
   * Add a `.cursorrules` entry on how Cursor should use it when asked questions about SEO for a URL.

6. **Add a simple UI page**
   * Let a user input a URL and see the agent's response.

**This time demo is the template:** small enough to understand in one sitting, but structured enough to scale.

---

## 8. Mental Model Summary ðŸŽ¯

This repo shows **Internal Orchestration v1.0**:
* Clean layering.
* Specs + contracts.
* Tests.
* AI-friendly tooling.

The **time demo** is:
* A toy domain used as a serious pattern sandbox.
* A place where human + AI dev tools learned to collaborate safely.
* A blueprint for future agentic flows (SEO, content, etc.).

When in doubt 6+ months from now:
* Read this file.
* Skim `docs/01-DEV-CONTRACT.md`.
* Look at:
  * `src/tools/timeTools.ts`
  * `src/agents/humanTimeAgent.ts`
  * `src/orchestrators/timeWorkflow.ts`
* Run:
  ```bash
  npm test
  npm run dev -- -p 3001
  npm run time:human-all
  ```

If all of that works and makes sense, you're back in the groove.